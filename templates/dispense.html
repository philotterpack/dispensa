{% extends "index.html" %}

{% block content %}
    <script>
        // Variabile globale dispense disponibile per tutti gli script
        const dispenseData = {{ dispense|tojson|safe }};
    </script>
    <h2>Gestione Dispense</h2>
    <p>Qui potrai creare, eliminare e modificare le tue dispense.</p>

    <h3>Crea una nuova dispensa</h3>
    <form id="crea-dispensa-form">
        <label for="nome_nuova_dispensa">Nome:</label>
        <input type="text" id="nome_nuova_dispensa" name="nome_nuova_dispensa" required><br><br>
        <button type="button" onclick="creaDispensa()">Crea</button>
    </form>

    <h3>Dispense esistenti</h3>
    <div class="dispense-list">
    {% if dispense %}
        {% for nome_dispensa, alimenti in dispense.items() %}
            <!-- changed: clicking a card now opens the dedicated dispensa page -->
            <div class="dispensa-card" onclick="apriPaginaDispensa('{{ nome_dispensa }}')">
                <div class="dispensa-title">{{ nome_dispensa }}</div>
                <div class="dispensa-info">{{ alimenti|length }} prodotti</div>
            </div>
        {% endfor %}
    {% else %}
        <p>Nessuna dispensa creata.</p>
    {% endif %}
    </div>

    <script>
       function creaDispensa() {
        const nome_nuova_dispensa = document.getElementById('nome_nuova_dispensa').value;
        fetch('/crea_dispensa', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: `nome_nuova_dispensa=${encodeURIComponent(nome_nuova_dispensa)}`
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            if (data.success) {
                window.location.reload();
            }
        });
    }

       // helper to open the dedicated dispensa detail page
       function apriPaginaDispensa(nome_dispensa) {
           // Encode component for safety in URL
           const encoded = encodeURIComponent(nome_dispensa);
           window.location.href = `/dispensa/${encoded}`;
       }

    </script>
{% endblock %}