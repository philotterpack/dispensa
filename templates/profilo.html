{% extends 'index.html' %}

{% block content %}
<div class="profilo-container">
    <h2>Il Tuo Profilo</h2>
    
    <div class="profilo-card">
        <form id="profilo-form" enctype="multipart/form-data">
            <!-- Foto Profilo -->
            <div class="foto-section">
                <div class="foto-preview">
                    <img id="foto-preview-img" src="{{ profilo.foto_url if profilo and profilo.foto_url else 'https://via.placeholder.com/150x150.png?text=Foto' }}" alt="Foto profilo">
                </div>
                <div class="foto-upload">
                    <label for="foto-input" class="btn-upload">
                        üì∑ Carica Foto
                    </label>
                    <input type="file" id="foto-input" accept="image/*" style="display: none;">
                    <p class="foto-hint">JPG, PNG o GIF (max 5MB)</p>
                </div>
            </div>

            <!-- Campi Profilo -->
            <div class="form-section">
                <div class="form-row">
                    <div class="form-group">
                        <label for="nome">Nome</label>
                        <input type="text" id="nome" name="nome" value="{{ profilo.nome if profilo else '' }}" placeholder="Mario">
                    </div>
                    <div class="form-group">
                        <label for="cognome">Cognome</label>
                        <input type="text" id="cognome" name="cognome" value="{{ profilo.cognome if profilo else '' }}" placeholder="Rossi">
                    </div>
                </div>

                <div class="form-group">
                    <label for="nickname">Nickname <span class="required">*</span></label>
                    <div class="nickname-input">
                        <span class="at-symbol">@</span>
                        <input type="text" id="nickname" name="nickname" value="{{ profilo.nickname if profilo else '' }}" placeholder="supermario" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="data_nascita">Data di Nascita <span class="required">*</span></label>
                    <input type="date" id="data_nascita" name="data_nascita" value="{{ profilo.data_nascita if profilo else '' }}" required>
                </div>

                <div class="form-group">
                    <label for="dieta">Dieta <span class="required">*</span></label>
                    <select id="dieta" name="dieta" required>
                        <option value="">Seleziona una dieta</option>
                        <option value="onnivora" {% if profilo and profilo.dieta == 'onnivora' %}selected{% endif %}>Onnivora</option>
                        <option value="vegetariana" {% if profilo and profilo.dieta == 'vegetariana' %}selected{% endif %}>Vegetariana</option>
                        <option value="vegana" {% if profilo and profilo.dieta == 'vegana' %}selected{% endif %}>Vegana</option>
                        <option value="pescetariana" {% if profilo and profilo.dieta == 'pescetariana' %}selected{% endif %}>Pescetariana</option>
                        <option value="senza_glutine" {% if profilo and profilo.dieta == 'senza_glutine' %}selected{% endif %}>Senza Glutine</option>
                        <option value="senza_lattosio" {% if profilo and profilo.dieta == 'senza_lattosio' %}selected{% endif %}>Senza Lattosio</option>
                        <option value="altra" {% if profilo and profilo.dieta == 'altra' %}selected{% endif %}>Altra</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="biografia">Biografia</label>
                    <textarea id="biografia" name="biografia" rows="4" placeholder="Raccontaci qualcosa di te...">{{ profilo.biografia if profilo else '' }}</textarea>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary">üíæ Salva Profilo</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
// Preview foto
document.getElementById('foto-input').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        if (file.size > 5 * 1024 * 1024) {
            alert('Il file √® troppo grande! Max 5MB');
            return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('foto-preview-img').src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
});

// Salva profilo
document.getElementById('profilo-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    formData.append('nome', document.getElementById('nome').value);
    formData.append('cognome', document.getElementById('cognome').value);
    formData.append('nickname', document.getElementById('nickname').value);
    formData.append('data_nascita', document.getElementById('data_nascita').value);
    formData.append('dieta', document.getElementById('dieta').value);
    formData.append('biografia', document.getElementById('biografia').value);
    
    const fotoInput = document.getElementById('foto-input');
    if (fotoInput.files[0]) {
        formData.append('foto', fotoInput.files[0]);
    }
    
    fetch('/salva_profilo', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ Profilo salvato con successo!');
        } else {
            alert('‚ùå Errore: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Errore:', error);
        alert('‚ùå Errore nel salvataggio del profilo');
    });
});
</script>
{% endblock %}
