{% extends "index.html" %}

{% block content %}
<style>
    .prodotti-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 22px;
        margin-top: 24px;
    }
    .prodotto-card {
        background: #f9fafc;
        border-radius: 14px;
        box-shadow: 0 2px 12px rgba(74,144,226,0.10);
        padding: 22px 18px 18px 18px;
        position: relative;
        display: flex;
        flex-direction: column;
        gap: 8px;
        border: 2px solid transparent;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    .prodotto-card.selected {
        border-color: #4a90e2;
        box-shadow: 0 4px 20px rgba(74,144,226,0.18);
    }
    .prodotto-header {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.15rem;
        font-weight: 600;
        color: #2a3b4c;
    }
    .prodotto-meta {
        font-size: 0.98rem;
        color: #666;
        margin-bottom: 4px;
    }
    .prodotto-extra {
        font-size: 0.92rem;
        color: #7b8aa3;
    }
    .scadenza-bar-bg {
        background: #eaf1fb;
        border-radius: 8px;
        height: 14px;
        width: 100%;
        margin-top: 8px;
        position: relative;
        overflow: hidden;
    }
    .scadenza-bar-fill {
        height: 100%;
        border-radius: 8px;
        background: linear-gradient(90deg, #4a90e2 0%, #e74c3c 100%);
        transition: width 0.3s;
    }
    .prodotto-checkbox {
        position: absolute;
        top: 16px;
        right: 16px;
        transform: scale(1.3);
    }
    .prodotti-actions {
        margin-top: 18px;
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }
    .btn-action {
        background: #4a90e2;
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 10px 18px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
    }
    .btn-action:hover {
        background: #357ab8;
    }
    .btn-danger {
        background: #e74c3c;
    }
    .btn-danger:hover {
        background: #c0392b;
    }
    .sorting-controls {
        margin-top: 18px;
        margin-bottom: 8px;
        display: flex;
        gap: 16px;
        align-items: center;
        flex-wrap: wrap;
    }
    .sorting-controls label {
        font-weight: 600;
        color: #357ab8;
        margin-right: 6px;
    }
    .dispensa-actions {
        margin-bottom: 18px;
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
    }
    .btn-modifica {
        background: #f1c40f;
        color: #2a3b4c;
        border: none;
        border-radius: 8px;
        padding: 10px 18px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
    }
    .btn-modifica:hover {
        background: #f7e08c;
    }
    .btn-elimina-dispensa {
        background: #e74c3c;
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 10px 18px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
    }
    .btn-elimina-dispensa:hover {
        background: #c0392b;
    }
    .btn-sposta-lista {
        background: #f1c40f;
        color: #2a3b4c;
        border: none;
        border-radius: 8px;
        padding: 8px 14px;
        font-size: 0.98rem;
        font-weight: 600;
        cursor: pointer;
        margin-top: 8px;
        transition: background 0.2s;
    }
    .btn-sposta-lista:hover {
        background: #f7e08c;
    }
    /* Modal modifica dispensa */
    .modal-bg {
        display: none;
        position: fixed;
        top:0; left:0; right:0; bottom:0;
        background: rgba(44,62,80,0.35);
        z-index: 3000;
        align-items: center;
        justify-content: center;
    }
    .modal-bg.show {
        display: flex;
    }
    .modal-content {
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 8px 32px rgba(44,62,80,0.18);
        padding: 32px 28px;
        min-width: 320px;
        max-width: 400px;
        position: relative;
    }
    .modal-content h3 {
        margin-top: 0;
        color: #2a3b4c;
        font-size: 1.3rem;
        margin-bottom: 18px;
    }
    .modal-content label {
        font-weight: 600;
        color: #357ab8;
        margin-bottom: 8px;
        display: block;
    }
    .modal-content input {
        width: 100%;
        padding: 10px 14px;
        border-radius: 8px;
        border: 2px solid #e0e0e0;
        font-size: 1rem;
        margin-bottom: 18px;
    }
    .modal-close {
        position: absolute;
        top: 12px;
        right: 16px;
        font-size: 1.5rem;
        background: none;
        border: none;
        color: #999;
        cursor: pointer;
    }
    .modal-close:hover {
        color: #e74c3c;
    }
</style>

<div class="dispensa-actions">
    <button class="btn-modifica" onclick="openModificaDispensaModal()">‚úèÔ∏è Modifica Dispensa</button>
    <button class="btn-elimina-dispensa" onclick="eliminaDispensa()">üóëÔ∏è Elimina Dispensa</button>
    <span style="font-size:1.1rem;color:#357ab8;font-weight:600;">{{ nome_dispensa }}</span>
</div>

<div class="sorting-controls">
    <label for="sort-key">Ordina per:</label>
    <select id="sort-key">
        <option value="name">Nome</option>
        <option value="scadenza">Data di scadenza</option>
        <option value="aggiunta">Data di aggiunta</option>
    </select>
    <select id="sort-order">
        <option value="asc">Crescente</option>
        <option value="desc">Decrescente</option>
    </select>
    <button onclick="applySort()" class="btn-action">Ordina</button>
    <span id="prodotti-count" style="margin-left:16px;color:#357ab8;font-weight:600;"></span>
</div>

<div class="prodotti-actions">
    <button class="btn-action btn-danger" onclick="eliminaSelezionati()">Elimina selezionati</button>
    <button class="btn-action" onclick="spostaSelezionati()">Sposta in altra dispensa</button>
    <!-- Altri bottoni funzione in futuro -->
</div>

<div class="prodotti-grid" id="prodotti-list"></div>

<!-- Modale modifica dispensa -->
<div class="modal-bg" id="modifica-dispensa-modal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeModificaDispensaModal()">√ó</button>
        <h3>Modifica Dispensa</h3>
        <form id="modifica-dispensa-form">
            <label for="nuovo-nome-dispensa">Nome Dispensa</label>
            <input type="text" id="nuovo-nome-dispensa" value="{{ nome_dispensa }}" required>
            <button type="submit" class="btn-modifica">Salva Modifiche</button>
        </form>
    </div>
</div>

<script>
const nomeDispensa = {{ nome_dispensa|tojson|safe }};
const prodottiData = {{ prodotti|tojson|safe }};
let prodottiArray = [];
let selectedProdotti = new Set();

function getAddedDate(prod) {
    return prod.aggiunta || prod.data_aggiunta || prod.added || prod.data_added || null;
}
function parseDateSafe(s) {
    if (!s) return null;
    const d = new Date(s);
    return isNaN(d) ? null : d;
}
function buildArrayFromData(obj) {
    const arr = [];
    for (const nome in obj) {
        arr.push(Object.assign({ nome: nome }, obj[nome]));
    }
    return arr;
}
function compareByKey(a, b, key) {
    if (key === 'name') return a.nome.localeCompare(b.nome, undefined, { sensitivity: 'base' });
    if (key === 'scadenza') {
        const da = parseDateSafe(a.scadenza), db = parseDateSafe(b.scadenza);
        if (!da && !db) return 0;
        if (!da) return 1;
        if (!db) return -1;
        return da - db;
    }
    if (key === 'aggiunta') {
        const da = parseDateSafe(getAddedDate(a)), db = parseDateSafe(getAddedDate(b));
        if (!da && !db) return 0;
        if (!da) return 1;
        if (!db) return -1;
        return da - db;
    }
    return 0;
}
function giorniAllaScadenza(scadenza) {
    if (!scadenza) return null;
    const oggi = new Date();
    const dataScadenza = new Date(scadenza);
    const diff = Math.ceil((dataScadenza - oggi) / (1000 * 60 * 60 * 24));
    return diff;
}
function percentualeScadenza(scadenza) {
    if (!scadenza) return 100;
    const oggi = new Date();
    const dataScadenza = new Date(scadenza);
    const diffTotale = 30; // Considera 30 giorni come "range" per la barra
    const diff = Math.ceil((dataScadenza - oggi) / (1000 * 60 * 60 * 24));
    let perc = Math.max(0, Math.min(100, (diff / diffTotale) * 100));
    return perc;
}
function renderList(sortedArray) {
    prodottiArray = sortedArray;
    const container = document.getElementById('prodotti-list');
    container.innerHTML = '';
    document.getElementById('prodotti-count').textContent = `${sortedArray.length} prodotti`;
    if (!sortedArray || sortedArray.length === 0) {
        container.innerHTML = '<div style="padding:18px;color:#999;">Nessun prodotto presente.</div>';
        return;
    }
    sortedArray.forEach((p, idx) => {
        const giorni = giorniAllaScadenza(p.scadenza);
        const perc = percentualeScadenza(p.scadenza);
        let barColor = perc > 60 ? '#4a90e2' : perc > 30 ? '#f1c40f' : '#e74c3c';
        let scadText = p.scadenza ? `Scadenza: ${p.scadenza}` : 'Scadenza: -';
        let giorniText = (giorni !== null && giorni >= 0) ? `Tra ${giorni} giorni` : (giorni < 0 ? `Scaduto da ${Math.abs(giorni)} giorni` : 'Data non valida');
        let meta = [];
        if (p.quantita !== undefined) meta.push(`Quantit√†: ${p.quantita} ${p.unita || ''}`);
        if (scadText) meta.push(scadText);
        if (getAddedDate(p)) meta.push(`Aggiunta: ${getAddedDate(p)}`);
        let extra = [p.categoria, p.tipo].filter(Boolean).join(' ');
        const selected = selectedProdotti.has(p.nome) ? 'selected' : '';
        container.innerHTML += `
        <div class="prodotto-card ${selected}" data-nome="${p.nome}">
            <input type="checkbox" class="prodotto-checkbox" data-nome="${p.nome}" ${selected ? 'checked' : ''} onchange="toggleProdottoSelezionato('${p.nome}')">
            <div class="prodotto-header">${p.nome}</div>
            <div class="prodotto-meta">${meta.join(' ‚Äî ')}</div>
            <div class="prodotto-extra">${extra}</div>
            <div class="scadenza-bar-bg">
                <div class="scadenza-bar-fill" style="width:${perc}%;background:${barColor};"></div>
            </div>
            <div style="font-size:0.95rem;color:${barColor};margin-top:2px;">${giorniText}</div>
            <button class="btn-sposta-lista" onclick="spostaInListaSpesa('${p.nome}', ${giorni < 0 ? '\'Prodotti Scaduti\'' : '\'Lista Spesa Generale\''})">
                Sposta in ${giorni < 0 ? 'Prodotti Scaduti' : 'Lista Spesa Generale'}
            </button>
        </div>
        `;
    });
}
function applySort() {
    const key = document.getElementById('sort-key').value;
    const order = document.getElementById('sort-order').value;
    const arr = buildArrayFromData(prodottiData);
    arr.sort((a, b) => {
        const cmp = compareByKey(a, b, key);
        return order === 'asc' ? cmp : -cmp;
    });
    renderList(arr);
}
function toggleProdottoSelezionato(nome) {
    if (selectedProdotti.has(nome)) {
        selectedProdotti.delete(nome);
    } else {
        selectedProdotti.add(nome);
    }
    renderList(prodottiArray);
}
function eliminaSelezionati() {
    if (selectedProdotti.size === 0) {
        alert('Seleziona almeno un prodotto da eliminare.');
        return;
    }
    if (!confirm('Vuoi eliminare i prodotti selezionati?')) return;
    selectedProdotti.forEach(nome => {
        fetch('/rimuovi', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: `nome_dispensa=${encodeURIComponent(nomeDispensa)}&nome_alimento=${encodeURIComponent(nome)}`
        })
        .then(response => response.json())
        .then(data => {
            // Aggiorna la pagina dopo l'eliminazione
            applySort();
        });
    });
    selectedProdotti.clear();
    setTimeout(applySort, 500);
}
function spostaSelezionati() {
    alert('Funzione sposta in altra dispensa in sviluppo!');
}
function openModificaDispensaModal() {
    document.getElementById('modifica-dispensa-modal').classList.add('show');
    document.getElementById('nuovo-nome-dispensa').value = nomeDispensa;
}
function closeModificaDispensaModal() {
    document.getElementById('modifica-dispensa-modal').classList.remove('show');
}
document.getElementById('modifica-dispensa-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const nuovoNome = document.getElementById('nuovo-nome-dispensa').value.trim();
    if (!nuovoNome) {
        alert('Il nome della dispensa non pu√≤ essere vuoto.');
        return;
    }
    fetch('/modifica_dispensa', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: `nome_dispensa_originale=${encodeURIComponent(nomeDispensa)}&nuovo_nome_dispensa=${encodeURIComponent(nuovoNome)}&alimenti=${JSON.stringify(prodottiData)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Nome dispensa modificato!');
            window.location.href = `/dispensa/${encodeURIComponent(nuovoNome)}`;
        } else {
            alert('Errore: ' + data.message);
        }
    });
});
function eliminaDispensa() {
    if (!confirm('Vuoi eliminare questa dispensa?')) return;
    fetch('/elimina_dispensa', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: `nome_dispensa=${encodeURIComponent(nomeDispensa)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Dispensa eliminata!');
            window.location.href = '/dispense';
        } else {
            alert('Errore: ' + data.message);
        }
    });
}
function spostaInListaSpesa(nomeProdotto, listaDestinazione) {
    fetch('/sposta_in_lista_spesa', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: `nome_dispensa=${encodeURIComponent(nomeDispensa)}&nome_alimento=${encodeURIComponent(nomeProdotto)}&lista_destinazione=${encodeURIComponent(listaDestinazione)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Prodotto spostato in ' + listaDestinazione);
            applySort();
        } else {
            alert('Errore: ' + data.message);
        }
    });
}
// initial render: default sort by name asc
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('sort-key').value = 'name';
    document.getElementById('sort-order').value = 'asc';
    applySort();
});
</script>
{% endblock %}