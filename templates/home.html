{% extends "index.html" %}

{% block content %}
<div class="home-container">
    <div class="home-header">
        <h2>ğŸ½ï¸ Aggiungi Alimento</h2>
        <p>Inserisci un nuovo alimento nella tua dispensa</p>
    </div>

    <div class="add-food-card">
        <form id="aggiungi-form" class="add-food-form">
            <div class="form-grid">
                <div class="form-group">
                    <label for="nome_dispensa">
                        <span class="label-icon">ğŸ“¦</span>
                        Nome Dispensa
                    </label>
                    <input type="text" id="nome_dispensa" name="nome_dispensa" list="dispense-list" placeholder="Seleziona o crea dispensa" required>
                    <datalist id="dispense-list">
                        {% for dispensa in dispense %}
                            <option value="{{ dispensa.nome_dispensa }}">
                        {% endfor %}
                    </datalist>
                </div>

                <div class="form-group">
                    <label for="nome_alimento">
                        <span class="label-icon">ğŸ¥—</span>
                        Nome Alimento
                    </label>
                    <input type="text" id="nome_alimento" name="nome_alimento" placeholder="Es: Pasta, Latte, Pomodori" required>
                </div>

                <div class="form-group">
                    <label for="quantita">
                        <span class="label-icon">ğŸ”¢</span>
                        QuantitÃ 
                    </label>
                    <input type="number" id="quantita" name="quantita" placeholder="1" min="1" required>
                </div>

                <div class="form-group">
                    <label for="unita">
                        <span class="label-icon">ğŸ“</span>
                        UnitÃ 
                    </label>
                    <select id="unita" name="unita">
                        <option value="unitÃ ">UnitÃ </option>
                        <option value="pacchetti">Pacchetti</option>
                        <option value="confezioni">Confezioni</option>
                        <option value="kg">Kg</option>
                        <option value="g">Grammi</option>
                        <option value="l">Litri</option>
                        <option value="ml">Millilitri</option>
                    </select>
                </div>

                <div class="form-group full-width">
                    <label for="scadenza">
                        <span class="label-icon">ğŸ“…</span>
                        Data di Scadenza
                    </label>
                    <input type="date" id="scadenza" name="scadenza" required>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" onclick="aggiungiAlimento()" class="btn-add">
                    â• Aggiungi Alimento
                </button>
            </div>
        </form>
    </div>

    <div class="quick-stats">
        <div class="stat-card">
            <div class="stat-icon">ğŸ“¦</div>
            <div class="stat-info">
                <div class="stat-number">{{ dispense|length }}</div>
                <div class="stat-label">Dispense</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">ğŸ¥«</div>
            <div class="stat-info">
                <div class="stat-number">
                    {% set total = namespace(count=0) %}
                    {% for dispensa in dispense %}
                        {% set total.count = total.count + dispensa.alimenti|length %}
                    {% endfor %}
                    {{ total.count }}
                </div>
                <div class="stat-label">Prodotti Totali</div>
            </div>
        </div>
    </div>
</div>

<script>
    const dispenseData = JSON.parse('{{ dispense|tojson|safe }}') || [];
    document.addEventListener('DOMContentLoaded', () => {
        const datalist = document.getElementById('dispense-list');
        datalist.innerHTML = '';
        dispenseData.forEach(dispensa => {
            const option = document.createElement('option');
            option.value = dispensa.nome_dispensa;
            datalist.appendChild(option);
        });
        
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('scadenza').setAttribute('min', today);
    });

    function aggiungiAlimento() {
        const nomeDispensa = document.getElementById('nome_dispensa').value;
        const nomeAlimento = document.getElementById('nome_alimento').value;
        const quantita = document.getElementById('quantita').value;
        const unita = document.getElementById('unita').value;
        const scadenza = document.getElementById('scadenza').value;

        if (!nomeDispensa || !nomeAlimento || !quantita || !scadenza) {
            alert('âš ï¸ Compila tutti i campi obbligatori!');
            return;
        }

        fetch('/aggiungi', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: `nome_dispensa=${encodeURIComponent(nomeDispensa)}&nome_alimento=${encodeURIComponent(nomeAlimento)}&quantita=${quantita}&unita=${unita}&scadenza=${scadenza}`
        })
        .then(response => response.json())
        .then(data => {
            alert('âœ… ' + data.message);
            window.location.href = '/dispense';
        })
        .catch(error => {
            console.error('Errore:', error);
            alert('âŒ Errore durante l\'aggiunta dell\'alimento');
        });
    }
</script>
{% endblock %}
